clc, clear, close all
%miaCartella = 'data';
miaCartella = 'long-term-movement-monitoring-database-1.0.0\3days'; % Folder that contains the data
pattern = fullfile(miaCartella, '*.hea'); % Creation of the search criterion (all the file .hea inside the specified folder)
elencoStruct = dir(pattern); % Trova tutti i file e le cartelle che corrispondono
nomiFile = {elencoStruct.name};    % % Estrai i nomi in un "vettore" (specificamente, un cell array) --> {'file1.hea', 'file2.hea', 'file3.hea'}

% initialization of walking percentage array
walking_percentage_CO=[]; 
walking_percentage_FL=[];
% initialization of total number of steps array
total_steps_CO=[]; 
total_steps_FL=[];
% initialization of stride time array
stride_time_CO=[]; 
stride_time_FL=[];

% Parameters initialization
Fs = 100; % Sampling frequency
window_sec = 1; % Finestra di analisi per SMA ed Energia
window = Fs * window_sec; % Campioni per finestra da 1s
min_bout_duration_sec = 60; % Durata minima bout di cammino

threshold_SMA_min = 0.135;      threshold_SMA_max = 0.8;    threshold_en = 0.05;

% HPF
Wn = 0.5 / (Fs / 2);
order = 4;
[B_hp, A_hp] = butter(order, Wn, 'high');
% LPF used for number of steps
Wn=5/(Fs/2);
[B_lp, A_lp] = butter(order, Wn);
% % LPF for SMA
% Wn=0.5/(Fs/2);
% [B_sma, A_sma] = butter(order, Wn);


for k = 1:1%length(nomiFile)
    record_name = char(nomiFile(k));
    record_name = record_name(1:5);
    %record_name = ['data\' record_name];                % Per settare il file path corretto
    record_name = ['long-term-movement-monitoring-database-1.0.0\3days\' record_name];   
    % Caricamento dati
    disp(['Loading data from: ', record_name, '...']);
    [signal, Fs, tm] = rdsamp(record_name);
    
    % Moe Nilsen algorithm for tilting correction 
    col_V = 1;     col_ML = 2;     col_AP = 3; % Column indices
    [aAP, aML, aV] = algo_Moe_Nilssen(signal(:,col_AP), signal(:,col_ML), signal(:,col_V), 'tiltAndNoG');
    
    % Pre-Processing (HPF) the accelerations
    aV_filt = filtfilt(B_hp, A_hp, aV);    aML_filt = filtfilt(B_hp, A_hp, aML);    aAP_filt = filtfilt(B_hp, A_hp, aAP);
    % limit is the number of 
    limit = floor(length(aV) / window);
   % function used to find SMA and energy
   %[SMA, energy] = SMA_energy_func(window,aV, aML, aAP,  Fs, limit, B_sma,A_sma); 
   [SMA, energy] = SMA_energy_func(window,aV_filt, aML_filt, aAP_filt, Fs, limit); 
    % Walking decision ( OR )
    walking = ((SMA > threshold_SMA_min) & (SMA < threshold_SMA_max)) | (energy > threshold_en);
    %walking =(SMA > threshold_SMA_min) & (SMA < threshold_SMA_max);
    % Function for the waking percentage
    [p_walking, bout_starts, bout_ends, bout_durations]=percentage_walking_func(walking,min_bout_duration_sec, limit);
    % Function for the number of steps
    [total_steps, FSs]=number_steps_func(B_lp,A_lp,Fs,window,min_bout_duration_sec,bout_starts,bout_ends,bout_durations,aAP,aAP_filt);
    % Function for the stride duration
    [stride_duration]=stride_duration_func(FSs);
    % Sorting between fallers and controls
    if record_name(end-4) == 'C'
        walking_percentage_CO = [walking_percentage_CO, p_walking]; % Store the percentage of walking for current file
        total_steps_CO=[total_steps_CO, total_steps];
        stride_time_CO=[stride_time_CO, stride_duration];
    else
        walking_percentage_FL = [walking_percentage_FL, p_walking]; % Store the percentage of walking for other files
        total_steps_FL=[total_steps_FL, total_steps];
        stride_time_FL=[stride_time_FL, stride_duration];
    end
end
% Output of all the parameters found
output_func(walking_percentage_CO, walking_percentage_FL, total_steps_CO, total_steps_FL, stride_time_CO, stride_time_FL)
